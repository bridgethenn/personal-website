---
title: "Lab1"
author: "Megan Roe-Leon"
date: "2025-10-28"
output: html_document
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

# **Lake Sixteen Field Run, Number 1**
From July 20th, 2025 to July 25th, 2025, The Burton Ecotoxicology Laboratory conducted field research in Lake Orion, Michigan. The experiments conducted are a part of the Aquatic Herbicide Project, led by Master Student Megan Roe-Leon. 

### Experiment Background Information
The purpose of this study is to explore the potential impact of glyphosate use on aquatic benthic macroinveretebrates. In this study, we utilize two test species *Daphnia magna* and *Hyalella azteca* for *in-situ* exposures. Using *in-situ* exposure chambers, we can consider environmentally realistic conditions while examining the potential impacts of glyphosate exposure, an advantage over traditional toxicity testing. 

### Experiment Set Up
At the Lake Orion Dog Park in Lake Orion, Michigan, there is a large lake named Lake Sixteen. Lake sixteen has a northern and a southern inlet. The northern inlet was utilized as a reference site, which did **NOT** receive glyphosate treatment. The southern inlet was utilized as the treated site, which **DID** receive glyphosate treatment. 

At each site, three mescososms were installed into the stream channel. Mesocosms were used in order to control for dissolved oxygen (DO), as they allowed for us to use aerators. Each mesocosm had 3 *in-situ* exposure chambers with ten of each test species inside. This means that each mesocosm had 30 *D. magna* and 30 *H. azteca*. In total, there were 90 reference organisms, 90 treated organisms,30 lab controls, and 30 travel controls for each test species.  

### Endpoints
After a 48 hour exposure period, organisms were taken back to the lab for post-exposure monitoring. We measure survival for both species, reproduction in *D. magna*, and biomass in *H. azteca*. In this document, we will only look at initial field exposure survival data. This means that the data we are looking at here is the initial survival of the test groups upon retrieval of organisms from the stream. Survival was recorded again after the post-exposure monitoring culture period, but that data is not explored in this document.  


```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(sf)
library(tidyverse)
library(ggplot2)
library(reshape2)
library(dplyr)
library(readxl)
library(binom)
library(emmeans)
library(car)
```

## *Daphnia magna* Survival Graph

We begin by cleaning up our dataframe so that it can easily be used. 

```{r}
field_sur <-read_excel("Field Survival.xlsx", sheet = "Run1")
head(field_sur) 


#column to classify into categories
field_sur$Category <- ifelse(grepl("Ref", field_sur$Treatment), "Ref",
ifelse(grepl("Treat", field_sur$Treatment), "Treat", NA))


#setting up proportions and total surivival because we will need to use Wilson 
#for CIs because our sample size is so small. N3 for 3 replicate groups. 

field_sur <- field_sur %>%
  mutate(
    Survivors = percent_survival * 10,
    Total = 10
  )


summary_fsurv <- field_sur %>%
  group_by(Treatment) %>%
  summarise(
    total_survivors = sum(Survivors),
    total_individuals = sum(Total),
    mean_survival = mean(percent_survival) #not actually % but proportion. 
  ) %>%
  rowwise() %>%
  mutate(
    ci = list(prop.test(total_survivors, total_individuals)$conf.int),
    ci_lower = ci[[1]],
    ci_upper = ci[[2]]
  ) %>%
  ungroup()
```

Now we can plot our *D. Magna* survival data.

```{r pressure, echo=FALSE}

# Plot daphnia field survival
ggplot(summary_fsurv, aes(x = Treatment, y = mean_survival, fill = Treatment)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2) +
  ylim(0, 1)  +
  theme_minimal() +
  labs(title = "Average D. magna Field Survival Proportion by Group",
       x = "Group",
       y = "Average Proportion Survived") +
  scale_fill_manual(values = c(
    "Ref M1" = "#ff7f00",
    "Ref M2" = "#ff7f00",
    "Ref M3" = "#ff7f00",
    "Treat M1" = "#e31a1c",
    "Treat M2" = "#e31a1c",
    "Treat M3" = "#e31a1c"
  )) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

By looking at this graph, there is seemingly no major differences in initial survival between the reference *D. magna* and the treatment *D. magna*. 

## *Hyalella azteca* Survival Graph

Similar to before, we will clean our initial survival data for *H. azteca* 

```{r}
field_sur_hya <-read_excel("Field Survival.xlsx", sheet = "Run1_Hya")
head(field_sur_hya) 

#column to classify into categories
field_sur_hya$Category <- ifelse(grepl("Ref", field_sur_hya$Treatment), "Ref",
                             ifelse(grepl("Treat", field_sur_hya$Treatment), "Treat", NA))


#setting up proportions and total surivival because we will need to use Wilson 
#for CIs because our sample size is so small. N3 for 3 replicate groups. 

field_sur_hya <- field_sur_hya %>%
  mutate(
    Survivors = percent_survival * 10,
    Total = 10
  )

summary_fsurv_hya <- field_sur_hya %>%
  group_by(Treatment) %>%
  summarise(
    total_survivors = sum(Survivors),
    total_individuals = sum(Total),
    mean_survival = mean(percent_survival) #not actually % but proportion. 
  ) %>%
  rowwise() %>%
  mutate(
    ci = list(prop.test(total_survivors, total_individuals)$conf.int),
    ci_lower = ci[[1]],
    ci_upper = ci[[2]]
  ) %>%
  ungroup()
```

Now, we can plot our initiate *H. azteca survival*

```{r, echo = FALSE}
# Plot hya field survival
ggplot(summary_fsurv_hya, aes(x = Treatment, y = mean_survival, fill = Treatment)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2) +
  ylim(0, 1)  +
  theme_minimal() +
  labs(title = "Average H. azteca Field Survival Proportion by Group",
       x = "Group",
       y = "Average Proportion Survived") +
  scale_fill_manual(values = c(
    "Ref M1" = "#ff7f00",
    "Ref M2" = "#ff7f00",
    "Ref M3" = "#ff7f00",
    "Treat M1" = "#e31a1c",
    "Treat M2" = "#e31a1c",
    "Treat M3" = "#e31a1c"
  )) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
By looking at this graph, we see that there may be some slight difference in initial survival between reference *H. azteca* and Treatment *H. azteca*. Further analysis and investigation is needed here. 

## Taking a look at Oakland County

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
#install.packages("tidycensus")
library(tidycensus)
library(tmap)
library(tmaptools)
library(dplyr)        
library(sf)      
library(RColorBrewer) 
library(classInt)     
library(tidyverse) 
#install.packages("cartography")
library(cartography)
#install.packages("SpatialPosition")
library(SpatialPosition)
library(maptiles) 
library(terra)
#install.packages("potential")
library(potential)
```

```{r, message=FALSE, warning=FALSE}
census_api_key("5bc5ba7171dcd2929c083e0b386a80949d6af4e0")
v2019 <- load_variables(2019, "acs5", cache = FALSE)
View(v2019)
Michigan <- get_acs(state = "MI", geography = "tract", variables = "B19013_001", geometry = TRUE, cb = FALSE)
head(Michigan)

racevars <- c(
  White      = "P005003",
  Black      = "P005004",
  Asian      = "P005006",
  Hispanic   = "P004003",
  HouseUnits = "H001001",
  Rent       = "H004004"
)

# Oakland County tracts with geometry; summary_var = total population (P001001)
Oakland <- tidycensus::get_decennial(
  geography   = "tract",
  variables   = racevars,
  state       = "MI",
  county      = "Oakland",
  year        = 2010,
  sumfile     = "sf1",      # explicit, though this is the default for 2010
  geometry    = TRUE,
  summary_var = "P001001"   # total population
)
head(Oakland)
```

Lake Orion Dog Park position within Oakland County is pictured below.

```{r}
# Plot Oakland County
Oakland <- sf::st_transform(Oakland, 26917)

epsg <- sf::st_crs(Oakland)$epsg
plot(sf::st_geometry(Oakland),
     col = "grey85", border = "grey30",
     main = paste0("Oakland County (EPSG:", epsg, ")"))
box()

lon <- -83.2667
lat <- 42.7495

# making coordinate point
lake16_point <- st_sfc(st_point(c(lon, lat)), crs = 4326) 
# Transform it to match Oakland's CRS (NAD83 / UTM zone 17N)
lake16_point <- sf::st_transform(lake16_point, sf::st_crs(Oakland))


# Plot the point
plot(lake16_point, col = "red", pch = 19, cex = 1.5, add = TRUE)

legend("bottomleft", legend = "Lake Orion Dog Park", pch = 19,
       col = "red", pt.cex = 1.5, bty = "n")

```

Below is a simple population density map for Oakland County, Michigan. When we look at the relative position of the research site, we see that is in an area with the lightest shade, indicating a relatively low population density. 

```{r}

# Reshape long -> wide so each group becomes its own column
Oakland <- Oakland %>%
  tidyr::pivot_wider(
    names_from  = variable,   # Asian, Black, Hispanic, White, etc.
    values_from = value,
    values_fill = 0           # fill missing group counts with 0
  ) 
names(Oakland)[names(Oakland) == "summary_value"] <- "Pop2010"

# Population density (people per km^2)
# st_area() returns m^2; convert to numeric and multiply by 1e6 to get per km^2
Oakland$PopDens <- 1e6 * Oakland$Pop2010 / as.numeric(sf::st_area(Oakland))

# Background
plot(sf::st_geometry(Oakland), col = NA, border = NA, bg = "gray95")

# Choropleth
cartography::choroLayer(
  x = Oakland,
  var = "PopDens",
  method = "quantile",
  nclass = 5,
  col = cartography::carto.pal(pal1 = "sand.pal", n1 = 5),
  border = "white",
  lwd = 0.5,
  legend.pos = "topright",
  legend.title.txt = "Population density\n(people per km^2)",
  add = TRUE
)

# Layout
cartography::layoutLayer(
  title   = "Population Distribution in Oakland County",
  sources = "Sources: US Census, 2010",
  author  = paste0("cartography ", utils::packageVersion("cartography")),
  frame   = FALSE, north = FALSE, tabtitle = TRUE, theme = "sand.pal"
)

# North arrow
cartography::north(pos = "topleft")
```